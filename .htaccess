# Enhanced .htaccess - Simplified and Optimized
DirectoryIndex index.php index.html

# Security and environment protection
<Files .env>
    Order allow,deny
    Deny from all
</Files>

<Files "*.log">
    Order allow,deny
    Deny from all
</Files>

<Files "*.sql">
    Order allow,deny
    Deny from all
</Files>

<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteBase /

    # Security - Block access to sensitive files
    RewriteRule ^(includes|database|config)/ - [F,L]
    
    # Redirect index.php to clean URL
    RewriteRule ^index\.php$ / [L,R=301]
    
    # SEO - Handle sitemap and robots.txt
    RewriteRule ^sitemap\.xml$ sitemap.xml.php [L]
    RewriteRule ^robots\.txt$ robots.txt.php [L]

    # ============================================================================
    # LEGACY REDIRECTS - Old URLs to new structure
    # ============================================================================
    
    # Old catalog and section redirects
    RewriteRule ^(catalog|ege_section|school_regions)\.php$ /index.php [L,R=301]
    RewriteRule ^write-to-editorial\.php$ /write [L,R=301]
    
    # Legacy post redirects
    RewriteRule ^(post_regions_ccuz|post_regions_vuz|post_ccuz)\.php$ /index.php [L,R=301]
    
    # Legacy entity redirects (old system)
    RewriteRule ^(rono|pu|mo|profil_vpo|profil_spo|ege|town_school|region_spo|region_vpo|region_school|ccuzprofilename|vuzprofilename)/(\d+)$ /index.php [L]
    
    # Legacy PHP file redirects
    RewriteRule ^(rono|ege|post_pu|post_regions_vuz|post_vuz|post_university|post_college|profil_spo|profil_vpo|view_post|ccuzproname|vuzproname|town_schools|town_spo|town_vpo|region_schools|region_spo|region_vpo)\.php$ /index.php [R=301,L]

    # ============================================================================
    # MODERN ROUTING - Current site structure
    # ============================================================================

    # Educational Institutions - All Regions
    RewriteRule ^schools-all-regions/?$ schools-all-regions-real.php [QSA,NC,L]
    RewriteRule ^vpo-all-regions/?$ vpo-all-regions-new.php [QSA,NC,L]
    RewriteRule ^spo-all-regions/?$ spo-all-regions-new.php [QSA,NC,L]
    RewriteRule ^educational-institutions-all-regions/?$ pages/common/educational-institutions-all-regions/educational-institutions-all-regions.php [QSA,NC,L]
    
    # Educational Institutions - By Region (directory listings)
    RewriteRule ^schools-in-region/?$ schools-in-region-real.php [QSA,NC,L]
    RewriteRule ^vpo-in-region/?$ vpo-in-region-new.php [QSA,NC,L]
    RewriteRule ^spo-in-region/?$ spo-in-region-new.php [QSA,NC,L]
    
    # Educational Institutions - By Region (specific region)
    RewriteRule ^schools-in-region/([a-zA-Z0-9-]+)/?$ schools-in-region-real.php?region_url=$1 [QSA,NC,L]
    RewriteRule ^vpo-in-region/([a-zA-Z0-9-]+)/?$ vpo-in-region-new.php?region_url=$1 [QSA,NC,L]
    RewriteRule ^spo-in-region/([a-zA-Z0-9-]+)/?$ spo-in-region-new.php?region_url=$1 [QSA,NC,L]
    
    # Educational Institutions - By Town  
    RewriteRule ^(schools|spo|vpo)/([^/]+)/([^/]+)/?$ educational-institutions-in-town-new.php?type=$1&region_name_en=$2&url_slug_town=$3 [L,QSA]

    # School Pages - ID-based URLs (301 redirect to slug URLs for SEO)
    RewriteRule ^school/(\d+)/?$ pages/school/school-redirect.php?id_school=$1 [QSA,NC,L]
    
    # School Pages - slug-based URLs (canonical URLs)
    RewriteRule ^school/([a-zA-Z0-9-]+)/?$ school-single-new.php?url_slug=$1 [QSA,NC,L]
    
    # VPO (Universities) - URL-based routing
    RewriteRule ^vpo/([^/]+)/?$ vpo-single-new.php?url_slug=$1 [QSA,NC,L]
    RewriteRule ^vpo/(\d+)/?$ pages/common/vpo-spo/redirect.php?id_university=$1 [L,QSA]
    RewriteRule ^high-edu/(.*)$ /vpo/$1 [R=301,L]
    
    # SPO (Colleges) - URL-based routing  
    RewriteRule ^spo/([^/]+)/?$ spo-single-new.php?url_slug=$1 [QSA,NC,L]
    RewriteRule ^spo/(\d+)/?$ pages/common/vpo-spo/redirect.php?id_college=$1 [L,QSA]
    RewriteRule ^middle-edu/(.*)$ /spo/$1 [R=301,L]

    # News System - slug-based
    RewriteRule ^news/?$ news-new.php [QSA,NC,L]
    RewriteRule ^news/novosti-vuzov/?$ news-new.php?news_type=vpo [QSA,NC,L]
    RewriteRule ^news/novosti-spo/?$ news-new.php?news_type=spo [QSA,NC,L]
    RewriteRule ^news/novosti-shkol/?$ news-new.php?news_type=school [QSA,NC,L]
    RewriteRule ^news/novosti-obrazovaniya/?$ news-new.php?news_type=education [QSA,NC,L]
    RewriteRule ^news/category/([^/]+)/?$ news-new.php?category_en=$1 [QSA,NC,L]
    RewriteRule ^news/([^/]+)/?$ news-new.php?url_news=$1 [QSA,NC,L]
    RewriteRule ^post/([^/]+)/?$ post-new.php?url_post=$1 [QSA,NC,L]
    
    # Edit routes
    RewriteRule ^edit/news/(\d+)/?$ dashboard-edit-content.php?type=news&id=$1 [QSA,NC,L]
    RewriteRule ^edit/post/(\d+)/?$ dashboard-edit-content.php?type=post&id=$1 [QSA,NC,L]
    
    # Redirect /posts to homepage (posts are shown there)
    RewriteRule ^posts/?$ / [R=301,L]
    
    # Categories - specific redirects first
    RewriteRule ^category/education-news/?$ /news [R=301,L]
    RewriteRule ^category/([^/]+)/?$ category-new.php?category_en=$1 [QSA,NC,L]

    # Tests System
    RewriteRule ^tests/?$ tests-new.php [QSA,NC,L]
    RewriteRule ^test/?$ test-single-new.php [QSA,NC,L]
    RewriteRule ^test/([^/]+)/?$ test-single-new.php?url_test=$1 [QSA,NC,L]
    RewriteRule ^test-full/([^/]+)/?$ test-full-new.php?test=$1 [QSA,NC,L]
    RewriteRule ^test-result/([^/]+)/?$ test-result-new.php?test=$1 [QSA,NC,L]

    # User System
    RewriteRule ^login/?$ login-template.php [QSA,NC,L]
    RewriteRule ^registration/?$ registration-new.php [QSA,NC,L]
    RewriteRule ^forgot-password/?$ forgot-password-new.php [QSA,NC,L]
    RewriteRule ^forgot-password-process/?$ forgot-password-process.php [QSA,NC,L]
    RewriteRule ^reset-password/?$ reset-password-new.php [QSA,NC,L]
    RewriteRule ^reset-password-confirm-process/?$ pages/account/reset-password/reset-password-confirm-process.php [QSA,NC,L]
    RewriteRule ^account/?$ account-new.php [QSA,NC,L]
    RewriteRule ^account/edit/?$ account-edit-new.php [QSA,NC,L]
    RewriteRule ^account/comments/?$ account-comments-new.php [QSA,NC,L]
    RewriteRule ^account/password-change/?$ password-change-new.php [QSA,NC,L]
    RewriteRule ^dashboard/?$ dashboard-professional-new.php [QSA,NC,L]
    RewriteRule ^dashboard/users/?$ dashboard-users-new.php [QSA,NC,L]
    RewriteRule ^dashboard/news/?$ dashboard-news-new.php [QSA,NC,L]
    RewriteRule ^dashboard/posts/?$ dashboard-posts-new.php [QSA,NC,L]
    RewriteRule ^dashboard/comments/?$ dashboard-comments-new.php [QSA,NC,L]
    RewriteRule ^dashboard/schools/?$ dashboard-schools-new.php [QSA,NC,L]
    RewriteRule ^dashboard/vpo/?$ dashboard-vpo-new.php [QSA,NC,L]
    RewriteRule ^dashboard/spo/?$ dashboard-spo-new.php [QSA,NC,L]
    RewriteRule ^create/(news|post)/?$ dashboard-create-content-unified.php?type=$1 [QSA,NC,L]
    RewriteRule ^create/?$ dashboard-create-content-unified.php [QSA,NC,L]
    RewriteRule ^create/process/?$ create-process.php [QSA,NC,L]
    RewriteRule ^edit/process/?$ edit-process.php [QSA,NC,L]
    RewriteRule ^logout/?$ simple_logout.php [QSA,NC,L]
    RewriteRule ^unauthorized/?$ unauthorized-new.php [QSA,NC,L]

    # Search
    RewriteRule ^search/?$ search-new.php [QSA,NC,L]
    RewriteRule ^search-process/?$ search-process-new.php [QSA,NC,L]

    # Static Pages
    RewriteRule ^about/?$ about-new.php [QSA,NC,L]
    RewriteRule ^write/?$ write-new.php [QSA,NC,L]
    RewriteRule ^write-success/?$ write-success.php [QSA,NC,L]
    RewriteRule ^thank-you/?$ thank-you-new.php [QSA,NC,L]
    RewriteRule ^privacy/?$ privacy-new.php [QSA,NC,L]
    RewriteRule ^terms/?$ terms-new.php [QSA,NC,L]
    RewriteRule ^cookie-consent/?$ cookie-consent-process.php [QSA,NC,L]

    # API Routes (if needed)
    RewriteRule ^api/([^/]+)/?$ api/$1.php [QSA,NC,L]

    # ============================================================================
    # LEGACY QUERY STRING REDIRECTS
    # ============================================================================
    
    # School redirects with query strings
    RewriteCond %{QUERY_STRING} (^|&)id_school=(\d+)(&|$)
    RewriteRule ^school\.php$ /school/%2? [R=301,L]
    
    # Post redirects with query strings
    RewriteCond %{QUERY_STRING} (^|&)id=(\d+)(&|$)
    RewriteRule ^view_post\.php$ /post/%2? [R=301,L]
    
    # VPO redirects with query strings
    RewriteCond %{QUERY_STRING} (^|&)id=(\d+)(&|$)
    RewriteRule ^vuzproname\.php$ /vpo/%2? [R=301,L]
    
    # SPO redirects with query strings
    RewriteCond %{QUERY_STRING} (^|&)id=(\d+)(&|$)
    RewriteRule ^ccuzproname\.php$ /spo/%2? [R=301,L]

    # ============================================================================
    # ERROR HANDLING
    # ============================================================================
    
    # Custom error pages
    ErrorDocument 404 /404-new.php
    ErrorDocument 500 /error-new.php
    
    # Direct error page route
    RewriteRule ^error/?$ /error-new.php [L]

    # ============================================================================
    # FALLBACK - Must be last
    # ============================================================================
    
    # If nothing else matches and file doesn't exist, go to 404
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule . /404-new.php [L]

</IfModule>

# ============================================================================
# PERFORMANCE AND SECURITY HEADERS
# ============================================================================

<IfModule mod_headers.c>
    # Security headers
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # Cache control for static assets
    <FilesMatch "\.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$">
        Header set Cache-Control "public, max-age=2592000"
    </FilesMatch>
</IfModule>

# Compression
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
</IfModule>